<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LocalStorage â†’ Supabase ë§ˆì´ê·¸ë ˆì´ì…˜</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .log {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
    }
    .log-info { color: #2196F3; }
    .log-success { color: #4CAF50; }
    .log-error { color: #f44336; }
    .log-warning { color: #ff9800; }
    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ LocalStorage â†’ Supabase ë§ˆì´ê·¸ë ˆì´ì…˜</h1>

    <div class="warning-box">
      <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong>
      <ul>
        <li>ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” LocalStorageì˜ todo ë°ì´í„°ë¥¼ Supabaseë¡œ ë³µì‚¬í•©ë‹ˆë‹¤</li>
        <li>ê¸°ì¡´ LocalStorage ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤</li>
        <li>ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ì— Supabaseì— ë¡œê·¸ì¸ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤</li>
      </ul>
    </div>

    <button id="migrateBtn" onclick="migrate()">ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘</button>

    <div class="log" id="logContainer"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // Supabase ì„¤ì • (í™˜ê²½ ë³€ìˆ˜ëŠ” ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´ í•„ìš”)
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

    let supabase;
    let userId;

    function log(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    window.migrate = async function() {
      const btn = document.getElementById('migrateBtn');
      btn.disabled = true;

      try {
        log('ğŸ”§ Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì¤‘...', 'info');
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
        log('ğŸ‘¤ ì‚¬ìš©ì ì¸ì¦ í™•ì¸ ì¤‘...', 'info');
        const { data: { user }, error: authError } = await supabase.auth.getUser();

        if (authError || !user) {
          log('âŒ ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
          return;
        }

        userId = user.id;
        log(`âœ… ì¸ì¦ ì™„ë£Œ: ${user.email} (ID: ${userId})`, 'success');

        // LocalStorageì—ì„œ ë°ì´í„° ì½ê¸°
        log('\nğŸ“‹ LocalStorageì—ì„œ ë°ì´í„° ì½ëŠ” ì¤‘...', 'info');

        const tasksData = localStorage.getItem('weave_v2_tasks');
        const sectionsData = localStorage.getItem('weave_v2_todo_sections');

        if (!tasksData && !sectionsData) {
          log('âš ï¸ LocalStorageì— ë§ˆì´ê·¸ë ˆì´ì…˜í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
          return;
        }

        // Tasks ë§ˆì´ê·¸ë ˆì´ì…˜
        if (tasksData) {
          log('\nğŸ”„ Tasks ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...', 'info');
          const tasks = JSON.parse(tasksData);
          log(`  ì´ ${tasks.length}ê°œ task ë°œê²¬`, 'info');

          for (const task of tasks) {
            // Supabase í¬ë§·ìœ¼ë¡œ ë³€í™˜
            const supabaseTask = {
              id: task.id,
              user_id: userId,
              title: task.title,
              description: task.description || null,
              status: task.status || 'pending',
              priority: task.priority || 'medium',
              due_date: task.dueDate || null,
              start_date: task.startDate || null,
              completed_at: task.completedAt || null,
              assignee_id: null,
              parent_task_id: task.parentTaskId || null,
              estimated_hours: task.estimatedHours || null,
              actual_hours: task.actualHours || null,
              tags: task.tags || [],
              attachments: task.attachments || [],
              recurring: task.recurring || null,
              checklist: task.checklist || [],
              created_at: task.createdAt || new Date().toISOString(),
              updated_at: new Date().toISOString()
            };

            // Supabaseì— ì €ì¥
            const { error } = await supabase
              .from('tasks')
              .upsert(supabaseTask);

            if (error) {
              log(`  âŒ Task "${task.title}" ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
            } else {
              log(`  âœ… Task "${task.title}" ì €ì¥ ì™„ë£Œ`, 'success');
            }
          }

          log(`âœ… Tasks ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ (${tasks.length}ê°œ)`, 'success');
        }

        // TodoSections ë§ˆì´ê·¸ë ˆì´ì…˜
        if (sectionsData) {
          log('\nğŸ”„ TodoSections ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...', 'info');
          const sections = JSON.parse(sectionsData);
          log(`  ì´ ${sections.length}ê°œ section ë°œê²¬`, 'info');

          for (const section of sections) {
            // Supabase í¬ë§·ìœ¼ë¡œ ë³€í™˜
            const supabaseSection = {
              id: section.id,
              user_id: userId,
              name: section.name,
              order_index: section.orderIndex || 0,
              is_expanded: section.isExpanded !== undefined ? section.isExpanded : true,
              color: section.color || null,
              icon: section.icon || null,
              created_at: section.createdAt || new Date().toISOString(),
              updated_at: new Date().toISOString()
            };

            // Supabaseì— ì €ì¥
            const { error } = await supabase
              .from('todo_sections')
              .upsert(supabaseSection);

            if (error) {
              log(`  âŒ Section "${section.name}" ì €ì¥ ì‹¤íŒ¨: ${error.message}`, 'error');
            } else {
              log(`  âœ… Section "${section.name}" ì €ì¥ ì™„ë£Œ`, 'success');
            }
          }

          log(`âœ… TodoSections ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ (${sections.length}ê°œ)`, 'success');
        }

        log('\nğŸ‰ ëª¨ë“  ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!', 'success');
        log('ğŸ’¡ ì´ì œ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ Supabaseì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.', 'info');

      } catch (error) {
        log(`âŒ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ${error.message}`, 'error');
        console.error(error);
      } finally {
        btn.disabled = false;
      }
    };

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í™˜ê²½ ë³€ìˆ˜ ì²´í¬
    window.addEventListener('DOMContentLoaded', () => {
      if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
        log('âš ï¸ ê²½ê³ : Supabase í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!', 'error');
        log('   ì´ HTML íŒŒì¼ì„ ì—´ê³  SUPABASE_URLê³¼ SUPABASE_ANON_KEYë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.', 'error');
        document.getElementById('migrateBtn').disabled = true;
      } else {
        log('âœ… Supabase ì„¤ì • í™•ì¸ ì™„ë£Œ', 'success');
        log('ğŸ’¡ "ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', 'info');
      }
    });
  </script>
</body>
</html>
