# ğŸ”’ Weave í”„ë¡œì íŠ¸ ë³´ì•ˆ ì·¨ì•½ì  ë¶„ì„ ë³´ê³ ì„œ

**ë¶„ì„ ì¼ì**: 2025-10-15
**ë¶„ì„ ë²”ìœ„**: ì¸ì¦, API, ë°ì´í„° ë³´í˜¸, RLS ì •ì±…, í´ë¼ì´ì–¸íŠ¸ ë³´ì•ˆ
**ê¸°ìˆ  ìŠ¤íƒ**: Next.js 15, React 19, Supabase
**ì „ë°˜ì  ë³´ì•ˆ ì ìˆ˜**: **6.5/10** (ì–‘í˜¸, ì¼ë¶€ ê°œì„  í•„ìš”)

---

## ğŸ“Š ìš”ì•½

í”„ë¡œì íŠ¸ëŠ” Supabase RLS ì •ì±…ê³¼ ì¸ì¦ í›„ Supabase-only ìŠ¤í† ë¦¬ì§€ ì „ëµì„ í†µí•´ ê¸°ë³¸ì ì¸ ë°ì´í„° ë³´í˜¸ë¥¼ ì˜ êµ¬í˜„í–ˆìœ¼ë‚˜, ì¸ì¦ ì •ì±…ê³¼ API ë³´ì•ˆì—ì„œ ê°œì„ ì´ í•„ìš”í•œ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.

**ì£¼ìš” ë°œê²¬ ì‚¬í•­:**
- ğŸ”´ **Critical**: Rate Limiting ë¶€ì¬ë¡œ ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²© ì·¨ì•½
- ğŸ”´ **Critical**: í”„ë¡œë•ì…˜ í™˜ê²½ ë¡œê¹…ìœ¼ë¡œ ë¯¼ê° ì •ë³´ ë…¸ì¶œ ìœ„í—˜
- ğŸŸ¡ **High**: ë¹„ë°€ë²ˆí˜¸ ì •ì±… ë¯¸í¡, ì…ë ¥ ê²€ì¦ ë¶€ì¡±, CSRF ë³´í˜¸ ë¶ˆëª…í™•, ë³´ì•ˆ í—¤ë” ë¯¸ì„¤ì •
- ğŸŸ¢ **Positive**: RLS ì •ì±… ì ì ˆíˆ êµ¬í˜„, Supabase-only ëª¨ë“œë¡œ ë°ì´í„° ë³´í˜¸ ì–‘í˜¸

**ë³´ì•ˆ ì ìˆ˜ ìƒì„¸:**
- ì¸ì¦/ì¸ê°€: 6/10 (RLSëŠ” ì–‘í˜¸, ì¸ì¦ ì •ì±… ì·¨ì•½)
- ë°ì´í„° ë³´í˜¸: 7/10 (Supabase-only ëª¨ë“œë¡œ ë¯¼ê° ë°ì´í„° ë³´í˜¸)
- API ë³´ì•ˆ: 5/10 (Rate Limiting ë¶€ì¬)
- ì „ë°˜ì  ë³´ì•ˆ: 6.5/10 (ì–‘í˜¸, ì¼ë¶€ ê°œì„  í•„ìš”)

---

## ğŸš¨ ë°œê²¬ëœ ì·¨ì•½ì  (ìš°ì„ ìˆœìœ„ë³„)

### ğŸ”´ Critical (ê¸´ê¸‰) - ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”

#### 1. Rate Limiting ë¶€ì¬

**ìœ„ì¹˜**:
- `src/app/api/auth/signin/route.ts`
- `src/app/api/auth/signup/route.ts`
- `src/app/api/auth/google/route.ts`
- ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸

**ë¬¸ì œì **:
- ëª¨ë“  ì¸ì¦ APIì— ì†ë„ ì œí•œì´ ì—†ìŒ
- ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²©(brute force) ì·¨ì•½
- ê³„ì • ì—´ê±° ê³µê²©(account enumeration) ê°€ëŠ¥
- DoS ê³µê²© ìœ„í—˜
- ë´‡ì´ ë¬´ì œí•œìœ¼ë¡œ API í˜¸ì¶œ ê°€ëŠ¥

**ì˜í–¥**:
- ë¹„ë°€ë²ˆí˜¸ ë¬´ì°¨ë³„ ëŒ€ì…ìœ¼ë¡œ ê³„ì • íƒˆì·¨ ê°€ëŠ¥
- ì„œë²„ ë¦¬ì†ŒìŠ¤ ê³ ê°ˆë¡œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ê°€ëŠ¥
- ë¹„ìš© ì¦ê°€ (Supabase, Vercel ì‚¬ìš©ëŸ‰ ê¸‰ì¦)

**ê¶Œì¥ ì¡°ì¹˜**:

```typescript
// ë°©ë²• 1: Vercel Edge Middleware + Upstash Redis (ê¶Œì¥)
// npm install @upstash/ratelimit @upstash/redis

// src/lib/ratelimit.ts
import { Ratelimit } from '@upstash/ratelimit'
import { Redis } from '@upstash/redis'

export const authRatelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(5, '1 m'), // 1ë¶„ì— 5íšŒ
  analytics: true,
  prefix: 'ratelimit:auth',
})

export const apiRatelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(100, '1 m'), // 1ë¶„ì— 100íšŒ
  analytics: true,
  prefix: 'ratelimit:api',
})

// src/app/api/auth/signin/route.ts
import { authRatelimit } from '@/lib/ratelimit'

export async function POST(request: Request) {
  // IP ê¸°ë°˜ Rate Limiting
  const ip = request.headers.get('x-forwarded-for') ?? 'unknown'
  const { success, limit, remaining, reset } = await authRatelimit.limit(ip)

  if (!success) {
    return NextResponse.json(
      {
        error: 'ìš”ì²­ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
        retryAfter: Math.ceil((reset - Date.now()) / 1000),
      },
      {
        status: 429,
        headers: {
          'X-RateLimit-Limit': limit.toString(),
          'X-RateLimit-Remaining': remaining.toString(),
          'X-RateLimit-Reset': reset.toString(),
        }
      }
    )
  }

  // ê¸°ì¡´ ë¡œê·¸ì¸ ë¡œì§...
}
```

```typescript
// ë°©ë²• 2: ê³„ì • ê¸°ë°˜ ì¶”ê°€ ì œí•œ (IP + ê³„ì • ì´ì¤‘ ë³´í˜¸)
// src/lib/ratelimit.ts

export async function checkAuthRateLimit(
  ip: string,
  email?: string
): Promise<{ success: boolean; error?: string }> {
  // IP ê¸°ë°˜ ì œí•œ
  const ipResult = await authRatelimit.limit(`ip:${ip}`)
  if (!ipResult.success) {
    return {
      success: false,
      error: `IP ì œí•œ: ${Math.ceil((ipResult.reset - Date.now()) / 1000)}ì´ˆ í›„ ì¬ì‹œë„`
    }
  }

  // ì´ë©”ì¼ ê¸°ë°˜ ì œí•œ (ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ)
  if (email) {
    const emailRatelimit = new Ratelimit({
      redis: Redis.fromEnv(),
      limiter: Ratelimit.slidingWindow(3, '5 m'), // 5ë¶„ì— 3íšŒ ì‹¤íŒ¨ í—ˆìš©
      prefix: 'ratelimit:email',
    })

    const emailResult = await emailRatelimit.limit(`email:${email}`)
    if (!emailResult.success) {
      return {
        success: false,
        error: `ê³„ì • ë³´í˜¸: ${Math.ceil((emailResult.reset - Date.now()) / 1000)}ì´ˆ í›„ ì¬ì‹œë„`
      }
    }
  }

  return { success: true }
}

// ì‚¬ìš©
const rateLimit = await checkAuthRateLimit(ip, email)
if (!rateLimit.success) {
  return NextResponse.json({ error: rateLimit.error }, { status: 429 })
}
```

```typescript
// ë°©ë²• 3: ì ì§„ì  ì§€ì—° (Exponential Backoff)
// src/lib/auth/failureTracking.ts

const failureMap = new Map<string, { count: number; lastAttempt: number }>()

export function getLoginDelay(identifier: string): number {
  const record = failureMap.get(identifier)
  if (!record) return 0

  // ì‹¤íŒ¨ íšŸìˆ˜ì— ë”°ë¼ ì§€ì—° ì‹œê°„ ì¦ê°€
  const delays = [0, 1000, 2000, 5000, 10000, 30000] // ms
  return delays[Math.min(record.count, delays.length - 1)]
}

export function recordFailure(identifier: string) {
  const record = failureMap.get(identifier) || { count: 0, lastAttempt: 0 }
  failureMap.set(identifier, {
    count: record.count + 1,
    lastAttempt: Date.now(),
  })
}

export function resetFailures(identifier: string) {
  failureMap.delete(identifier)
}

// ì‚¬ìš©
const delay = getLoginDelay(email)
if (delay > 0) {
  await new Promise(resolve => setTimeout(resolve, delay))
}
```

---

#### 2. í”„ë¡œë•ì…˜ í™˜ê²½ ë¡œê¹…

**ìœ„ì¹˜**:
- `src/app/api/auth/google/route.ts:5-7`

**ë¬¸ì œì **:

```typescript
console.log('ğŸ”µ [GOOGLE OAUTH] Starting Google OAuth flow...')
console.log('ğŸ”µ [ENV CHECK] NEXT_PUBLIC_SITE_URL:', process.env.NEXT_PUBLIC_SITE_URL)
console.log('ğŸ”µ [ENV CHECK] All NEXT_PUBLIC_ vars:', Object.keys(process.env).filter(k => k.startsWith('NEXT_PUBLIC_')))
```

- í”„ë¡œë•ì…˜ì—ì„œ í™˜ê²½ ë³€ìˆ˜ê°€ ë¡œê·¸ë¡œ ì¶œë ¥ë¨
- ë¡œê·¸ ìˆ˜ì§‘ ì‹œìŠ¤í…œ(Vercel Logs, Datadog ë“±)ì—ì„œ ë¯¼ê° ì •ë³´ ë…¸ì¶œ ìœ„í—˜
- process.env ê°ì²´ ì „ì²´ë¥¼ ë¡œê¹…í•˜ë©´ ì˜ˆìƒì¹˜ ëª»í•œ ë¹„ë°€ ë…¸ì¶œ ê°€ëŠ¥
- ë””ë²„ê¹… ì½”ë“œê°€ í”„ë¡œë•ì…˜ì— ë‚¨ì•„ìˆìŒ

**ì˜í–¥**:
- í™˜ê²½ ë³€ìˆ˜ ë…¸ì¶œë¡œ ì‹œìŠ¤í…œ êµ¬ì„± ì •ë³´ ìœ ì¶œ
- API í‚¤, ë°ì´í„°ë² ì´ìŠ¤ URL ë“± ë¯¼ê° ì •ë³´ ë…¸ì¶œ ê°€ëŠ¥
- ë¡œê·¸ ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ëª¨ë“  ì‚¬ëŒì—ê²Œ ì •ë³´ ë…¸ì¶œ

**ê¶Œì¥ ì¡°ì¹˜**:

```typescript
// ë°©ë²• 1: í™˜ê²½ë³„ ë¡œê¹… ë¶„ê¸°
// src/app/api/auth/google/route.ts

export async function GET() {
  // ê°œë°œ í™˜ê²½ì—ì„œë§Œ ë¡œê¹…
  if (process.env.NODE_ENV === 'development') {
    console.log('[DEV] Starting Google OAuth flow')
    console.log('[DEV] NEXT_PUBLIC_SITE_URL:', process.env.NEXT_PUBLIC_SITE_URL)
  }

  // í”„ë¡œë•ì…˜ì—ì„œëŠ” êµ¬ì¡°í™”ëœ ë¡œê¹…ë§Œ
  if (process.env.NODE_ENV === 'production') {
    // ë¯¼ê° ì •ë³´ ì œì™¸í•˜ê³  ì´ë²¤íŠ¸ë§Œ ê¸°ë¡
    console.log(JSON.stringify({
      event: 'oauth_start',
      provider: 'google',
      timestamp: new Date().toISOString(),
    }))
  }

  // ... OAuth ë¡œì§
}
```

```typescript
// ë°©ë²• 2: êµ¬ì¡°í™”ëœ ë¡œê¹… ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (ê¶Œì¥)
// npm install pino pino-pretty

// src/lib/logger.ts
import pino from 'pino'

const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  // í”„ë¡œë•ì…˜ì—ì„œëŠ” JSON í¬ë§·
  ...((process.env.NODE_ENV === 'production')
    ? {}
    : { transport: { target: 'pino-pretty' } }
  ),
  // ë¯¼ê° ì •ë³´ ìë™ ì œê±°
  redact: {
    paths: [
      'req.headers.authorization',
      'req.headers.cookie',
      'password',
      'token',
      '*.password',
      '*.token',
    ],
    remove: true,
  },
})

export default logger

// ì‚¬ìš©
import logger from '@/lib/logger'

logger.info({ event: 'oauth_start', provider: 'google' })
logger.error({ err, event: 'oauth_error' }, 'OAuth failed')
```

```typescript
// ë°©ë²• 3: í™˜ê²½ ë³€ìˆ˜ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸
// src/lib/logger.ts

const SAFE_ENV_VARS = [
  'NODE_ENV',
  'NEXT_PUBLIC_APP_NAME',
  'NEXT_PUBLIC_APP_URL',
  // ë¯¼ê°í•˜ì§€ ì•Šì€ public ë³€ìˆ˜ë§Œ í¬í•¨
]

export function logSafeEnvVars() {
  const safeEnv = Object.entries(process.env)
    .filter(([key]) => SAFE_ENV_VARS.includes(key))
    .reduce((acc, [key, value]) => ({ ...acc, [key]: value }), {})

  console.log('[ENV]', safeEnv)
}
```

---

### ğŸŸ¡ High (ë†’ìŒ) - ë‹¨ê¸° ì¡°ì¹˜ í•„ìš”

#### 3. ë¹„ë°€ë²ˆí˜¸ ì •ì±… ë¯¸í¡

**ìœ„ì¹˜**:
- `src/app/api/auth/signup/route.ts:16-21`

**ë¬¸ì œì **:

```typescript
if (password.length < 6) {
  return NextResponse.json(
    { error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' },
    { status: 400 }
  )
}
```

- ìµœì†Œ 6ìë§Œ ìš”êµ¬ (NIST ê¶Œì¥ ìµœì†Œ 8ì, ì¼ë°˜ì ìœ¼ë¡œ 10ì ì´ìƒ ê¶Œì¥)
- ë³µì¡ë„ ìš”êµ¬ì‚¬í•­ ì—†ìŒ (ëŒ€ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì í˜¼í•©)
- ì¼ë°˜ì ì¸ ë¹„ë°€ë²ˆí˜¸ ì°¨ë‹¨ ì—†ìŒ (password123, 123456 ë“±)
- ì—°ì†ëœ ë¬¸ì, ë°˜ë³µ ë¬¸ì ê²€ì¦ ì—†ìŒ

**ì˜í–¥**:
- ì•½í•œ ë¹„ë°€ë²ˆí˜¸ë¡œ ê³„ì • ìƒì„± ê°€ëŠ¥
- ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²© ì„±ê³µ í™•ë¥  ì¦ê°€
- ì‚¬ì „ ê³µê²©(dictionary attack) ì·¨ì•½

**ê¶Œì¥ ì¡°ì¹˜**:

```typescript
// ë°©ë²• 1: Zodë¥¼ ì‚¬ìš©í•œ ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (ê¶Œì¥)
// npm install zod

// src/lib/validation/password.ts
import { z } from 'zod'

// ì¼ë°˜ì ì¸ ë¹„ë°€ë²ˆí˜¸ ëª©ë¡ (ì‹¤ì œë¡œëŠ” ë” í° ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©)
const COMMON_PASSWORDS = [
  'password', 'password123', '12345678', 'qwerty123',
  'abc123', '111111', '123456', '123456789',
  'password1', 'qwerty', 'admin', 'letmein',
]

export const passwordSchema = z.string()
  .min(10, 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 10ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.')
  .max(128, 'ë¹„ë°€ë²ˆí˜¸ëŠ” 128ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
  .regex(/[A-Z]/, 'ëŒ€ë¬¸ìë¥¼ 1ê°œ ì´ìƒ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.')
  .regex(/[a-z]/, 'ì†Œë¬¸ìë¥¼ 1ê°œ ì´ìƒ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.')
  .regex(/[0-9]/, 'ìˆ«ìë¥¼ 1ê°œ ì´ìƒ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.')
  .regex(/[^A-Za-z0-9]/, 'íŠ¹ìˆ˜ë¬¸ìë¥¼ 1ê°œ ì´ìƒ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.')
  .refine((pwd) => !COMMON_PASSWORDS.includes(pwd.toLowerCase()), {
    message: 'ì¼ë°˜ì ì¸ ë¹„ë°€ë²ˆí˜¸ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
  })
  .refine((pwd) => !/(.)\1{2,}/.test(pwd), {
    message: 'ë™ì¼í•œ ë¬¸ìë¥¼ 3ë²ˆ ì´ìƒ ì—°ì† ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
  })
  .refine((pwd) => !/012|123|234|345|456|567|678|789|890/.test(pwd), {
    message: 'ì—°ì†ëœ ìˆ«ìë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
  })

// src/app/api/auth/signup/route.ts
import { passwordSchema } from '@/lib/validation/password'

export async function POST(request: Request) {
  const { email, password, name } = await request.json()

  // ë¹„ë°€ë²ˆí˜¸ ê²€ì¦
  const result = passwordSchema.safeParse(password)
  if (!result.success) {
    return NextResponse.json(
      { error: result.error.issues[0].message },
      { status: 400 }
    )
  }

  // ... ê¸°ì¡´ ë¡œì§
}
```

```typescript
// ë°©ë²• 2: Have I Been Pwned APIë¡œ ìœ ì¶œëœ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
// npm install @jdanford/pwned

// src/lib/validation/password.ts
import { pwned } from '@jdanford/pwned'

export async function checkPwnedPassword(password: string): Promise<boolean> {
  try {
    const count = await pwned(password)
    return count > 0 // ìœ ì¶œëœ ì ì´ ìˆìœ¼ë©´ true
  } catch (error) {
    // API ì˜¤ë¥˜ ì‹œ ê²€ì¦ í†µê³¼ (ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ë°©ì§€)
    console.error('Pwned API check failed:', error)
    return false
  }
}

// íšŒì›ê°€ì… ì‹œ ì¶”ê°€ ê²€ì¦
const isPwned = await checkPwnedPassword(password)
if (isPwned) {
  return NextResponse.json(
    { error: 'ì´ ë¹„ë°€ë²ˆí˜¸ëŠ” ê³¼ê±° ë°ì´í„° ìœ ì¶œì—ì„œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.' },
    { status: 400 }
  )
}
```

```typescript
// ë°©ë²• 3: ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ì ìˆ˜ í‘œì‹œ (í´ë¼ì´ì–¸íŠ¸)
// npm install zxcvbn

// src/components/auth/PasswordStrengthMeter.tsx
import zxcvbn from 'zxcvbn'

export function PasswordStrengthMeter({ password }: { password: string }) {
  const result = zxcvbn(password)
  const score = result.score // 0-4

  const colors = ['red', 'orange', 'yellow', 'lightgreen', 'green']
  const labels = ['ë§¤ìš° ì•½í•¨', 'ì•½í•¨', 'ë³´í†µ', 'ê°•í•¨', 'ë§¤ìš° ê°•í•¨']

  return (
    <div>
      <div className="strength-bar" style={{ backgroundColor: colors[score] }} />
      <p>ë¹„ë°€ë²ˆí˜¸ ê°•ë„: {labels[score]}</p>
      {result.feedback.warning && <p className="warning">{result.feedback.warning}</p>}
      {result.feedback.suggestions.map((s, i) => (
        <p key={i} className="suggestion">{s}</p>
      ))}
    </div>
  )
}
```

---

#### 4. ì…ë ¥ ê²€ì¦ ë¶€ì¡±

**ìœ„ì¹˜**:
- `src/app/api/auth/signup/route.ts`
- `src/app/api/auth/signin/route.ts`
- `src/lib/storage/adapters/SupabaseAdapter.ts`

**ë¬¸ì œì **:
- ì´ë©”ì¼ í˜•ì‹ ê²€ì¦ ì—†ìŒ (ì •ê·œì‹, DNS ê²€ì¦ ë“±)
- name í•„ë“œ ê¸¸ì´ ì œí•œ ì—†ìŒ â†’ ë²„í¼ ì˜¤ë²„í”Œë¡œìš°, í‘œì‹œ ë¬¸ì œ
- íŠ¹ìˆ˜ë¬¸ì í•„í„°ë§ ì—†ìŒ â†’ XSS, ì£¼ì… ê³µê²© ê°€ëŠ¥ì„±
- SupabaseAdapter parseKeyì—ì„œ ë””ë ‰í† ë¦¬ íƒìƒ‰ ë¬¸ì ê²€ì¦ ì—†ìŒ

**ì˜í–¥**:
- ì˜ëª»ëœ í˜•ì‹ì˜ ë°ì´í„° ì €ì¥
- XSS ê³µê²© ê°€ëŠ¥ì„±
- SQL/NoSQL ì£¼ì… ê°€ëŠ¥ì„±
- ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ë‚­ë¹„ (ë„ˆë¬´ ê¸´ ë¬¸ìì—´)

**ê¶Œì¥ ì¡°ì¹˜**:

```typescript
// ë°©ë²• 1: Zod ìŠ¤í‚¤ë§ˆë¡œ ì „ì²´ ì…ë ¥ ê²€ì¦ (ê¶Œì¥)
// src/lib/validation/auth.ts

import { z } from 'zod'
import { passwordSchema } from './password'

export const signupSchema = z.object({
  email: z.string()
    .min(1, 'ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')
    .email('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.')
    .max(255, 'ì´ë©”ì¼ì€ 255ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    .toLowerCase()
    .trim(),

  password: passwordSchema,

  name: z.string()
    .min(2, 'ì´ë¦„ì€ ìµœì†Œ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.')
    .max(50, 'ì´ë¦„ì€ 50ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    .regex(/^[a-zA-Zê°€-í£\s]+$/, 'ì´ë¦„ì— íŠ¹ìˆ˜ë¬¸ìë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    .trim()
    .transform(name => name.replace(/\s+/g, ' ')), // ì¤‘ë³µ ê³µë°± ì œê±°
})

export const signinSchema = z.object({
  email: z.string()
    .min(1, 'ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')
    .email('ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.')
    .toLowerCase()
    .trim(),

  password: z.string()
    .min(1, 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'),
})

// src/app/api/auth/signup/route.ts
import { signupSchema } from '@/lib/validation/auth'

export async function POST(request: Request) {
  try {
    const body = await request.json()

    // ì…ë ¥ ê²€ì¦
    const result = signupSchema.safeParse(body)
    if (!result.success) {
      return NextResponse.json(
        {
          error: result.error.issues[0].message,
          issues: result.error.issues, // ëª¨ë“  ì˜¤ë¥˜ ë°˜í™˜
        },
        { status: 400 }
      )
    }

    const { email, password, name } = result.data // ê²€ì¦ëœ ë°ì´í„° ì‚¬ìš©

    // ... ê¸°ì¡´ ë¡œì§
  } catch (error) {
    // JSON íŒŒì‹± ì˜¤ë¥˜ ì²˜ë¦¬
    if (error instanceof SyntaxError) {
      return NextResponse.json(
        { error: 'ì˜ëª»ëœ ìš”ì²­ í˜•ì‹ì…ë‹ˆë‹¤.' },
        { status: 400 }
      )
    }
    throw error
  }
}
```

```typescript
// ë°©ë²• 2: HTML íƒœê·¸ ë° ìŠ¤í¬ë¦½íŠ¸ ì œê±° (ì¶”ê°€ ë³´ì•ˆ)
// npm install dompurify isomorphic-dompurify

// src/lib/validation/sanitize.ts
import DOMPurify from 'isomorphic-dompurify'

export function sanitizeInput(input: string): string {
  // HTML íƒœê·¸ ì™„ì „ ì œê±°
  return DOMPurify.sanitize(input, {
    ALLOWED_TAGS: [], // ëª¨ë“  íƒœê·¸ ì œê±°
    ALLOWED_ATTR: [], // ëª¨ë“  ì†ì„± ì œê±°
  }).trim()
}

export function sanitizeObject<T extends Record<string, any>>(obj: T): T {
  const sanitized = {} as T

  for (const [key, value] of Object.entries(obj)) {
    if (typeof value === 'string') {
      sanitized[key as keyof T] = sanitizeInput(value) as any
    } else {
      sanitized[key as keyof T] = value
    }
  }

  return sanitized
}

// ì‚¬ìš©
const sanitized = sanitizeObject({ email, password, name })
```

```typescript
// ë°©ë²• 3: SupabaseAdapter parseKey ë³´ì•ˆ ê°•í™”
// src/lib/storage/adapters/SupabaseAdapter.ts

private parseKey(key: string): { entity: string; id: string | null; subkey: string | null } {
  // ë³´ì•ˆ ê²€ì¦ ì¶”ê°€
  if (!key || typeof key !== 'string') {
    throw new StorageError('Invalid key format', 'ADAPTER_ERROR')
  }

  // ë””ë ‰í† ë¦¬ íƒìƒ‰ ê³µê²© ë°©ì–´
  if (key.includes('..') || key.includes('/') || key.includes('\\')) {
    throw new StorageError(
      'Invalid characters in key',
      'ADAPTER_ERROR',
      { severity: 'high', userMessage: 'ì˜ëª»ëœ í‚¤ í˜•ì‹ì…ë‹ˆë‹¤.' }
    )
  }

  // ê¸¸ì´ ì œí•œ
  if (key.length > 256) {
    throw new StorageError('Key too long', 'ADAPTER_ERROR')
  }

  const parts = key.split(':')

  // íŒŒíŠ¸ ê°œìˆ˜ ì œí•œ
  if (parts.length > 3) {
    throw new StorageError('Invalid key format', 'ADAPTER_ERROR')
  }

  return {
    entity: parts[0] || '',
    id: parts[1] || null,
    subkey: parts[2] || null,
  }
}
```

---

#### 5. CSRF ë³´í˜¸ ë¶ˆëª…í™•

**ìœ„ì¹˜**:
- `src/lib/supabase/middleware.ts:37-43`
- ëª¨ë“  POST API ì—”ë“œí¬ì¸íŠ¸

**ë¬¸ì œì **:

```typescript
// IMPORTANT: Avoid writing any logic between createServerClient and
// supabase.auth.getUser(). A simple mistake could make your server
// vulnerable to CSRF attacks.
```

- ì£¼ì„ìœ¼ë¡œë§Œ CSRF ê²½ê³ , ëª…ì‹œì  ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜ ì—†ìŒ
- Supabase SSRì´ ìë™ìœ¼ë¡œ CSRFë¥¼ ë°©ì–´í•˜ëŠ”ì§€ ë¶ˆëª…í™•
- POST ìš”ì²­ì— Origin/Referer ê²€ì¦ ì—†ìŒ
- CSRF í† í° ìƒì„±/ê²€ì¦ ë¡œì§ ì—†ìŒ

**ì˜í–¥**:
- ì•…ì„± ì‚¬ì´íŠ¸ì—ì„œ ì‚¬ìš©ì ì„¸ì…˜ì„ ì´ìš©í•œ ìš”ì²­ ê°€ëŠ¥
- ê³„ì • ì„¤ì • ë³€ê²½, ë°ì´í„° ìƒì„±/ìˆ˜ì •/ì‚­ì œ ë“± ìœ„í—˜

**ê¶Œì¥ ì¡°ì¹˜**:

```typescript
// ë°©ë²• 1: Next.js App Router ê¸°ë³¸ CSRF ë³´í˜¸ í™œìš© + Origin ê²€ì¦
// src/middleware.ts

import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export async function middleware(request: NextRequest) {
  // POST, PUT, DELETE ìš”ì²­ì— ëŒ€í•´ Origin ê²€ì¦
  if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(request.method)) {
    const origin = request.headers.get('origin')
    const host = request.headers.get('host')

    // Originì´ ì—†ê±°ë‚˜ í˜¸ìŠ¤íŠ¸ì™€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì°¨ë‹¨
    if (origin && !origin.endsWith(host || '')) {
      console.warn(`[CSRF] Blocked request from ${origin} to ${host}`)
      return new Response('Forbidden: Invalid origin', { status: 403 })
    }
  }

  // Supabase ë¯¸ë“¤ì›¨ì–´ ì‹¤í–‰
  return await updateSession(request)
}

export const config = {
  matcher: [
    '/api/:path*',
    '/dashboard/:path*',
    '/((?!_next/static|_next/image|favicon.ico).*)',
  ],
}
```

```typescript
// ë°©ë²• 2: CSRF í† í° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš© (ë” ê°•ë ¥í•œ ë³´í˜¸)
// npm install csrf

// src/lib/csrf.ts
import { createHash, randomBytes } from 'crypto'

const CSRF_SECRET = process.env.CSRF_SECRET || randomBytes(32).toString('hex')

export function generateCsrfToken(sessionId: string): string {
  const token = randomBytes(32).toString('hex')
  const hash = createHash('sha256')
    .update(`${token}.${sessionId}.${CSRF_SECRET}`)
    .digest('hex')

  return `${token}.${hash}`
}

export function verifyCsrfToken(token: string, sessionId: string): boolean {
  const [tokenPart, hashPart] = token.split('.')

  if (!tokenPart || !hashPart) {
    return false
  }

  const expectedHash = createHash('sha256')
    .update(`${tokenPart}.${sessionId}.${CSRF_SECRET}`)
    .digest('hex')

  return hashPart === expectedHash
}

// API ë¼ìš°íŠ¸ì—ì„œ ì‚¬ìš©
import { verifyCsrfToken } from '@/lib/csrf'
import { cookies } from 'next/headers'

export async function POST(request: Request) {
  const cookieStore = await cookies()
  const sessionId = cookieStore.get('session-id')?.value

  if (!sessionId) {
    return NextResponse.json({ error: 'No session' }, { status: 401 })
  }

  const csrfToken = request.headers.get('x-csrf-token')

  if (!csrfToken || !verifyCsrfToken(csrfToken, sessionId)) {
    return NextResponse.json({ error: 'Invalid CSRF token' }, { status: 403 })
  }

  // ... ì•ˆì „í•œ ìš”ì²­ ì²˜ë¦¬
}
```

```typescript
// ë°©ë²• 3: SameSite Cookie ì„¤ì • (ì¶”ê°€ ë³´í˜¸)
// Supabaseê°€ ìë™ìœ¼ë¡œ ì„¤ì •í•˜ì§€ë§Œ í™•ì¸ í•„ìš”

// src/lib/supabase/middleware.ts
export async function updateSession(request: NextRequest) {
  // ... ê¸°ì¡´ ì½”ë“œ

  // ì¿ í‚¤ ì„¤ì • ì‹œ SameSite ì˜µì…˜ í™•ì¸
  cookiesToSet.forEach(({ name, value, options }) => {
    supabaseResponse.cookies.set(name, value, {
      ...options,
      sameSite: 'lax', // ë˜ëŠ” 'strict'
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
    })
  })

  return supabaseResponse
}
```

---

#### 6. ë³´ì•ˆ í—¤ë” ë¯¸ì„¤ì •

**ìœ„ì¹˜**:
- `next.config.js` (ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í•„ìš”)

**ë¬¸ì œì **:
- Content-Security-Policy (CSP) ì—†ìŒ â†’ XSS ê³µê²© ë°©ì–´ ë¶€ì¡±
- X-Frame-Options ì—†ìŒ â†’ í´ë¦­ì¬í‚¹ ê³µê²© ì·¨ì•½
- X-Content-Type-Options ì—†ìŒ â†’ MIME ìŠ¤ë‹ˆí•‘ ê³µê²© ì·¨ì•½
- Strict-Transport-Security ì—†ìŒ â†’ HTTPS ê°•ì œ ì—†ìŒ

**ì˜í–¥**:
- XSS ê³µê²© ì‹œ ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê°€ëŠ¥
- iframeìœ¼ë¡œ í˜ì´ì§€ ì‚½ì…í•˜ì—¬ í´ë¦­ì¬í‚¹ ê³µê²© ê°€ëŠ¥
- ë¸Œë¼ìš°ì € MIME íƒ€ì… ì˜¤íŒìœ¼ë¡œ ë³´ì•ˆ ìš°íšŒ ê°€ëŠ¥

**ê¶Œì¥ ì¡°ì¹˜**:

```javascript
// next.config.js (ìƒˆë¡œ ìƒì„± ë˜ëŠ” ìˆ˜ì •)

/** @type {import('next').NextConfig} */
const nextConfig = {
  async headers() {
    return [
      {
        // ëª¨ë“  ê²½ë¡œì— ë³´ì•ˆ í—¤ë” ì ìš©
        source: '/:path*',
        headers: [
          // í´ë¦­ì¬í‚¹ ë°©ì–´
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          // MIME ìŠ¤ë‹ˆí•‘ ë°©ì–´
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          // Referer ì •ì±…
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
          // ê¶Œí•œ ì •ì±…
          {
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=(), payment=()',
          },
          // HTTPS ê°•ì œ (í”„ë¡œë•ì…˜)
          {
            key: 'Strict-Transport-Security',
            value: 'max-age=63072000; includeSubDomains; preload',
          },
          // XSS ë³´í˜¸
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block',
          },
          // Content Security Policy (XSS ë°©ì–´)
          {
            key: 'Content-Security-Policy',
            value: [
              "default-src 'self'",
              "script-src 'self' 'unsafe-eval' 'unsafe-inline'", // Next.js í•„ìš”
              "style-src 'self' 'unsafe-inline'", // Tailwind í•„ìš”
              "img-src 'self' data: https: blob:",
              "font-src 'self' data:",
              "connect-src 'self' https://*.supabase.co wss://*.supabase.co",
              "frame-ancestors 'none'",
              "base-uri 'self'",
              "form-action 'self'",
            ].join('; '),
          },
        ],
      },
    ]
  },

  // ì¶”ê°€ ë³´ì•ˆ ì„¤ì •
  reactStrictMode: true,
  poweredByHeader: false, // X-Powered-By í—¤ë” ì œê±°
}

module.exports = nextConfig
```

```javascript
// CSP Nonceë¥¼ ì‚¬ìš©í•œ ë” ê°•ë ¥í•œ ë³´í˜¸ (ì„ íƒì‚¬í•­)
// middleware.ts

import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'
import { randomBytes } from 'crypto'

export function middleware(request: NextRequest) {
  const nonce = randomBytes(16).toString('base64')

  const cspHeader = [
    "default-src 'self'",
    `script-src 'self' 'nonce-${nonce}' 'strict-dynamic'`,
    `style-src 'self' 'nonce-${nonce}'`,
    // ... ë‚˜ë¨¸ì§€ CSP
  ].join('; ')

  const requestHeaders = new Headers(request.headers)
  requestHeaders.set('x-nonce', nonce)
  requestHeaders.set('Content-Security-Policy', cspHeader)

  const response = NextResponse.next({
    request: {
      headers: requestHeaders,
    },
  })

  response.headers.set('Content-Security-Policy', cspHeader)

  return response
}
```

---

### ğŸŸ  Medium (ì¤‘ê°„) - ì¤‘ê¸° ì¡°ì¹˜ ê¶Œì¥

#### 7. ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ì •ì±… ë¯¸ì •ì˜

**ë¬¸ì œì **:
- ëª…ì‹œì ì¸ ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ì„¤ì • ì—†ìŒ
- Supabase ê¸°ë³¸ ì„¤ì •ì— ì˜ì¡´ (ì¼ë°˜ì ìœ¼ë¡œ 1ì‹œê°„ access token, 7ì¼ refresh token)
- ì¥ê¸°ê°„ ë¯¸ì‚¬ìš© ì„¸ì…˜ ì²˜ë¦¬ ë¡œì§ ì—†ìŒ
- "Remember Me" ê¸°ëŠ¥ ì—†ìŒ

**ê¶Œì¥ ì¡°ì¹˜**:

```typescript
// src/lib/supabase/client.ts
import { createBrowserClient } from '@supabase/ssr'

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      auth: {
        // ìë™ í† í° ê°±ì‹  í™œì„±í™”
        autoRefreshToken: true,
        // ì„¸ì…˜ ì§€ì†ì„± í™œì„±í™”
        persistSession: true,
        // URLì—ì„œ ì„¸ì…˜ ê°ì§€
        detectSessionInUrl: true,
        // ì„¸ì…˜ ë§Œë£Œ ì‹œê°„ ì„¤ì • (ì´ˆ ë‹¨ìœ„)
        // ì°¸ê³ : Supabase ì„œë²„ ì„¤ì •ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
        flowType: 'pkce',
      },
    }
  )
}
```

```typescript
// í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¹„í™œì„± ì‹œê°„ ì¶”ì 
// src/hooks/useInactivityTimeout.ts

import { useEffect } from 'react'
import { useRouter } from 'next/navigation'

const INACTIVITY_TIMEOUT = 30 * 60 * 1000 // 30ë¶„

export function useInactivityTimeout() {
  const router = useRouter()

  useEffect(() => {
    let timeoutId: NodeJS.Timeout

    const resetTimer = () => {
      clearTimeout(timeoutId)
      localStorage.setItem('lastActivity', Date.now().toString())

      timeoutId = setTimeout(() => {
        // 30ë¶„ ë¹„í™œì„± í›„ ìë™ ë¡œê·¸ì•„ì›ƒ
        router.push('/api/auth/signout')
      }, INACTIVITY_TIMEOUT)
    }

    // ì‚¬ìš©ì í™œë™ ê°ì§€
    const events = ['mousedown', 'keydown', 'scroll', 'touchstart']
    events.forEach(event => {
      document.addEventListener(event, resetTimer)
    })

    // ì´ˆê¸° íƒ€ì´ë¨¸ ì„¤ì •
    resetTimer()

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë§ˆì§€ë§‰ í™œë™ ì‹œê°„ í™•ì¸
    const lastActivity = localStorage.getItem('lastActivity')
    if (lastActivity) {
      const elapsed = Date.now() - Number(lastActivity)
      if (elapsed > INACTIVITY_TIMEOUT) {
        router.push('/api/auth/signout')
      }
    }

    return () => {
      clearTimeout(timeoutId)
      events.forEach(event => {
        document.removeEventListener(event, resetTimer)
      })
    }
  }, [router])
}

// Layoutì—ì„œ ì‚¬ìš©
// src/app/layout.tsx
import { useInactivityTimeout } from '@/hooks/useInactivityTimeout'

export default function RootLayout({ children }: { children: React.ReactNode }) {
  useInactivityTimeout() // ì „ì—­ì—ì„œ í™œì„±í™”

  return (
    <html>
      <body>{children}</body>
    </html>
  )
}
```

---

#### 8. .gitignore í™•ì¸ ë° ë¹„ë°€ ê´€ë¦¬

**ê¶Œì¥ ì¡°ì¹˜**:

```bash
# .gitignore í™•ì¸ ë° ì¶”ê°€
.env
.env.local
.env.*.local
.env.production
.env.production.local
.env.development.local

# Supabase
.supabase/

# ê¸°íƒ€ ë¯¼ê° íŒŒì¼
*.pem
*.key
*.crt
secrets/
```

```bash
# git-secrets ì„¤ì¹˜ ë° ì„¤ì •
# macOS
brew install git-secrets

# í”„ë¡œì íŠ¸ì— ì„¤ì¹˜
git secrets --install

# AWS íŒ¨í„´ ë“±ë¡
git secrets --register-aws

# ì»¤ìŠ¤í…€ íŒ¨í„´ ì¶”ê°€
git secrets --add 'SUPABASE_.*_KEY'
git secrets --add 'NEXT_PUBLIC_SUPABASE_.*'

# ì „ì²´ íˆìŠ¤í† ë¦¬ ìŠ¤ìº”
git secrets --scan-history
```

```bash
# pre-commit hook ì¶”ê°€
# .git/hooks/pre-commit

#!/bin/sh

# .env íŒŒì¼ ì»¤ë°‹ ë°©ì§€
if git diff --cached --name-only | grep -E "\.env(\.|$)"; then
  echo "âŒ Error: .env íŒŒì¼ì„ ì»¤ë°‹í•˜ë ¤ê³  í•©ë‹ˆë‹¤!"
  echo "ë¯¼ê°í•œ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
  exit 1
fi

# API í‚¤ íŒ¨í„´ ê²€ìƒ‰
if git diff --cached | grep -iE "(api[_-]?key|secret[_-]?key|password|token).*=.*['\"][^'\"]{20,}['\"]"; then
  echo "âš ï¸  Warning: API í‚¤ë‚˜ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³´ì´ëŠ” ë¬¸ìì—´ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
  echo "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n)"
  read -r response
  if [ "$response" != "y" ]; then
    exit 1
  fi
fi

exit 0
```

---

#### 9. XSS ë°©ì–´ ê°•í™”

**ê¶Œì¥ ì¡°ì¹˜**:

```typescript
// DOMPurifyë¡œ ì‚¬ìš©ì ì…ë ¥ sanitize
// npm install dompurify isomorphic-dompurify
// npm install -D @types/dompurify

// src/lib/sanitize.ts
import DOMPurify from 'isomorphic-dompurify'

export function sanitizeHTML(dirty: string, options?: DOMPurify.Config): string {
  return DOMPurify.sanitize(dirty, {
    ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'p', 'br'],
    ALLOWED_ATTR: ['href', 'title'],
    ALLOW_DATA_ATTR: false,
    ...options,
  })
}

// ì‚¬ìš© ì˜ˆì‹œ
// src/components/ProjectDescription.tsx
import { sanitizeHTML } from '@/lib/sanitize'

export function ProjectDescription({ html }: { html: string }) {
  const clean = sanitizeHTML(html)

  return <div dangerouslySetInnerHTML={{ __html: clean }} />
}
```

---

### ğŸŸ¢ Low (ë‚®ìŒ) - ì¥ê¸° ê°œì„  ì‚¬í•­

#### 10. ë™ì‹œ ì„¸ì…˜ ì œí•œ

**ê¶Œì¥ ì¡°ì¹˜**: ì‚¬ìš©ìê°€ ë™ì‹œì— ì—¬ëŸ¬ ë””ë°”ì´ìŠ¤ì—ì„œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆëŠ”ì§€ ì •ì±… ê²°ì • í•„ìš”. í•„ìš” ì‹œ ì„¸ì…˜ í…Œì´ë¸”ì„ ì¶”ê°€í•˜ì—¬ ê´€ë¦¬.

---

#### 11. API Key ìˆœí™˜ ì •ì±…

**ê¶Œì¥ ì¡°ì¹˜**:
- Supabase, Gemini, OpenAI ë“± API í‚¤ë¥¼ ë¶„ê¸°ë³„ë¡œ ìˆœí™˜
- í‚¤ ìœ ì¶œ ì‹œ ëŒ€ì‘ ì ˆì°¨ ë¬¸ì„œí™”
- í‚¤ ë§Œë£Œ ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬ì¶•

---

#### 12. ì˜ì¡´ì„± ì •ê¸° ì ê²€

**ê¶Œì¥ ì¡°ì¹˜**:

```bash
# ë¶„ê¸°ë³„ ì‹¤í–‰
npm audit
npm audit fix

# ì·¨ì•½ì  ì‹¬ê°ë„ë³„ í™•ì¸
npm audit --production

# ì˜¤ë˜ëœ íŒ¨í‚¤ì§€ í™•ì¸
npm outdated

# ìë™í™” (GitHub Actions)
# .github/workflows/security-audit.yml
name: Security Audit
on:
  schedule:
    - cron: '0 0 * * 1' # ë§¤ì£¼ ì›”ìš”ì¼
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm audit --audit-level=high
```

---

## âœ… ê¸ì •ì  ë°œê²¬ ì‚¬í•­

### 1. RLS ì •ì±… ìš°ìˆ˜
- Supabase RLSê°€ ëª¨ë“  í…Œì´ë¸”ì— ì ì ˆíˆ êµ¬í˜„ë¨
- users, projects, clients, documents ë“± ëª¨ë“  í…Œì´ë¸”ì—ì„œ `auth.uid() = user_id` í™•ì¸
- ì‚¬ìš©ì ë°ì´í„° ê²©ë¦¬ê°€ ì˜ ì´ë£¨ì–´ì ¸ ìˆìŒ

### 2. ì¸ì¦ ì‹œìŠ¤í…œ ë¶„ë¦¬
- ì„œë²„ ì»´í¬ë„ŒíŠ¸ìš© `createClient()`ì™€ í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ìš© `createClient()` ë¶„ë¦¬
- ì¿ í‚¤ ê¸°ë°˜ ì„¸ì…˜ ê´€ë¦¬ë¡œ XSS ê³µê²© ì‹œ í† í° íƒˆì·¨ ë°©ì–´

### 3. í™œë™ ë¡œê·¸
- `activity_logs` í…Œì´ë¸”ë¡œ ì‚¬ìš©ì í™œë™ ì¶”ì  ê°€ëŠ¥
- ê°ì‚¬(audit) ê¸°ëŠ¥ìœ¼ë¡œ ë³´ì•ˆ ì‚¬ê³  ì¡°ì‚¬ ì§€ì›

### 4. íŠ¸ëœì­ì…˜ ì§€ì›
- `StorageManager`ì—ì„œ ë¡¤ë°± ê°€ëŠ¥í•œ íŠ¸ëœì­ì…˜ êµ¬í˜„
- ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

---

## ğŸ¯ ì¦‰ì‹œ ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸

### â° ì´ë²ˆ ì£¼ ë‚´ (Critical)

- [ ] **Rate Limiting êµ¬í˜„**
  - [ ] Upstash Redis + Vercel Edge Middleware ì„¤ì •
  - [ ] `/api/auth/*` ì—”ë“œí¬ì¸íŠ¸ì— ì ìš© (1ë¶„ì— 5íšŒ)
  - [ ] 429 ì—ëŸ¬ í•¸ë“¤ë§ êµ¬í˜„

- [ ] **í”„ë¡œë•ì…˜ ë¡œê¹… ì œê±°**
  - [ ] `google/route.ts`ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œê¹… ì œê±°
  - [ ] í™˜ê²½ë³„ ë¡œê¹… ë¶„ê¸° ì ìš© (`NODE_ENV === 'development'`)
  - [ ] êµ¬ì¡°í™”ëœ ë¡œê¹… ë¼ì´ë¸ŒëŸ¬ë¦¬ ë„ì… (pino ë“±)

- [ ] **.gitignore í™•ì¸ ë° ë¹„ë°€ ìŠ¤ìº”**
  - [ ] `.env` íŒŒì¼ì´ `.gitignore`ì— ìˆëŠ”ì§€ í™•ì¸
  - [ ] `git-secrets` ë„êµ¬ ì„¤ì¹˜ ë° ì„¤ì •
  - [ ] pre-commit hook ì¶”ê°€

---

### ğŸ“… ë‹¤ìŒ ì£¼ (High)

- [ ] **ë¹„ë°€ë²ˆí˜¸ ì •ì±… ê°•í™”**
  - [ ] ìµœì†Œ 10ì ì´ìƒ + ë³µì¡ë„ ìš”êµ¬ì‚¬í•­
  - [ ] Zod ìŠ¤í‚¤ë§ˆë¡œ ê²€ì¦ êµ¬í˜„
  - [ ] ì¼ë°˜ì ì¸ ë¹„ë°€ë²ˆí˜¸ ì°¨ë‹¨ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€

- [ ] **ì…ë ¥ ê²€ì¦ ê°•í™”**
  - [ ] ì´ë©”ì¼, name ë“± ëª¨ë“  ì‚¬ìš©ì ì…ë ¥ì— Zod ìŠ¤í‚¤ë§ˆ ì ìš©
  - [ ] SupabaseAdapter `parseKey`ì— ë³´ì•ˆ ê²€ì¦ ì¶”ê°€
  - [ ] HTML íƒœê·¸ sanitize ì¶”ê°€

- [ ] **CSRF ëª…ì‹œì  ê²€ì¦**
  - [ ] Origin í—¤ë” ê²€ì¦ ì¶”ê°€
  - [ ] CSRF í† í° ë¼ì´ë¸ŒëŸ¬ë¦¬ ë„ì… (ì„ íƒ)
  - [ ] SameSite Cookie ì„¤ì • í™•ì¸

- [ ] **ë³´ì•ˆ í—¤ë” ì„¤ì •**
  - [ ] `next.config.js`ì— ë³´ì•ˆ í—¤ë” ì¶”ê°€
  - [ ] CSP, X-Frame-Options, HSTS ë“± ì„¤ì •
  - [ ] í”„ë¡œë•ì…˜ ë°°í¬ í›„ í—¤ë” í™•ì¸

---

### ğŸ“† ì´ë²ˆ ë‹¬ (Medium)

- [ ] **ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ ì •ì±…**
  - [ ] ë¹„í™œì„± ì‹œê°„ ì¶”ì  í›… êµ¬í˜„
  - [ ] 30ë¶„ ë¹„í™œì„± í›„ ìë™ ë¡œê·¸ì•„ì›ƒ
  - [ ] Supabase ì„¸ì…˜ ì„¤ì • ëª…ì‹œ

- [ ] **XSS ë°©ì–´ ê°•í™”**
  - [ ] DOMPurify ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
  - [ ] ì‚¬ìš©ì ì…ë ¥ HTML sanitize
  - [ ] CSP Nonce ì ìš© (ì„ íƒ)

- [ ] **ë³´ì•ˆ ê°ì‚¬ ë¡œê·¸**
  - [ ] ë¡œê·¸ì¸ ì‹¤íŒ¨ ì´ë²¤íŠ¸ ë¡œê¹…
  - [ ] ê¶Œí•œ ì˜¤ë¥˜ ë¡œê¹…
  - [ ] ë³´ì•ˆ ê´€ë ¨ ì´ë²¤íŠ¸ ì¶”ì 

- [ ] **ì˜ì¡´ì„± ì ê²€**
  - [ ] `npm audit` ì‹¤í–‰
  - [ ] ì·¨ì•½í•œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
  - [ ] GitHub Actionsë¡œ ìë™í™”

---

## ğŸ“ˆ ê¸°ëŒ€ íš¨ê³¼

### ë‹¨ê¸° (1-2ì£¼)
- Rate Limitingìœ¼ë¡œ ë¬´ì°¨ë³„ ëŒ€ì… ê³µê²© ë°©ì–´
- í”„ë¡œë•ì…˜ ë¡œê¹… ì œê±°ë¡œ ë¯¼ê° ì •ë³´ ë…¸ì¶œ ë°©ì§€
- ë³´ì•ˆ ì ìˆ˜: **6.5 â†’ 7.5**

### ì¤‘ê¸° (1ê°œì›”)
- ì…ë ¥ ê²€ì¦ ê°•í™”ë¡œ ì£¼ì… ê³µê²© ë°©ì–´
- ë³´ì•ˆ í—¤ë” ì„¤ì •ìœ¼ë¡œ XSS, í´ë¦­ì¬í‚¹ ë°©ì–´
- ë¹„ë°€ë²ˆí˜¸ ì •ì±… ê°•í™”ë¡œ ê³„ì • ë³´ì•ˆ í–¥ìƒ
- ë³´ì•ˆ ì ìˆ˜: **7.5 â†’ 8.5**

### ì¥ê¸° (3ê°œì›”)
- ì¢…í•©ì ì¸ ë³´ì•ˆ ì²´ê³„ êµ¬ì¶•
- OWASP Top 10 ëŒ€ì‘ ì™„ë£Œ
- ë³´ì•ˆ ì ìˆ˜: **8.5 â†’ 9.5+**

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [OWASP Top 10 2021](https://owasp.org/Top10/)
- [Supabase Security Best Practices](https://supabase.com/docs/guides/auth/server-side-rendering)
- [Next.js Security Headers](https://nextjs.org/docs/app/api-reference/next-config-js/headers)
- [Web Crypto API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API)
- [NIST Password Guidelines](https://pages.nist.gov/800-63-3/sp800-63b.html)
- [Content Security Policy (CSP)](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)

---

## ğŸ”„ ë‹¤ìŒ ì ê²€ ì¼ì •

- **ì •ê¸° ì ê²€**: 3ê°œì›” í›„ (2026-01-15)
- **ì˜ì¡´ì„± ì ê²€**: ë§¤ì›” 1ì¼
- **ë³´ì•ˆ ì—…ë°ì´íŠ¸**: ì¦‰ì‹œ ì ìš©

---

**ë³´ê³ ì„œ ì‘ì„±**: Claude (Anthropic)
**ë¶„ì„ ë°©ë²•**: Sequential Thinking + ìˆ˜ë™ ì½”ë“œ ë¦¬ë·°
**ë¶„ì„ ë„êµ¬**: Static Analysis, Pattern Matching
**ë¬¸ì˜**: ì¶”ê°€ êµ¬í˜„ ì§€ì› í•„ìš” ì‹œ ìš”ì²­

---

## ğŸ“ ë³´ì•ˆ êµìœ¡ ê¶Œì¥ ì‚¬í•­

íŒ€ì›ë“¤ì—ê²Œ ë‹¤ìŒ ë³´ì•ˆ êµìœ¡ì„ ê¶Œì¥í•©ë‹ˆë‹¤:

1. **OWASP Top 10** ì´í•´
2. **Secure Coding Practices** í•™ìŠµ
3. **Supabase RLS** ì‹¬í™” í•™ìŠµ
4. **Next.js Security** ëª¨ë²” ì‚¬ë¡€
5. **ì•”í˜¸í•™ ê¸°ì´ˆ** (AES, HMAC, JWT ë“±)

---

**ë©´ì±… ì¡°í•­**: ì´ ë³´ê³ ì„œëŠ” ì½”ë“œ ì •ì  ë¶„ì„ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìœ¼ë©°, ëŸ°íƒ€ì„ ë™ì  ë¶„ì„ì´ë‚˜ ì¹¨íˆ¬ í…ŒìŠ¤íŠ¸ëŠ” í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì „ë¬¸ ë³´ì•ˆ ì—…ì²´ì˜ ì¢…í•© ë³´ì•ˆ ì§„ë‹¨ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
