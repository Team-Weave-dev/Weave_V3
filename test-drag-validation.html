<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 드래그 검증 테스트</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            background: #f5f5f5;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        pre {
            background: #fff;
            padding: 10px;
            overflow-x: auto;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Task 드래그 검증 테스트</h1>

    <div class="section">
        <h2>1. LocalStorage 데이터 확인</h2>
        <button onclick="checkLocalStorage()">LocalStorage 확인</button>
        <pre id="localStorage-output"></pre>
    </div>

    <div class="section">
        <h2>2. Task 검증 테스트 (상세 디버깅)</h2>
        <button onclick="validateTasks()">Tasks 검증 시작</button>
        <pre id="validation-output"></pre>
    </div>

    <div class="section">
        <h2>3. Update 시뮬레이션 테스트</h2>
        <label>Task ID: <input type="text" id="taskId" placeholder="task ID 입력"></label>
        <button onclick="simulateUpdate()">Update 시뮬레이션</button>
        <pre id="update-output"></pre>
    </div>

    <div class="section">
        <h2>4. 문제가 있는 필드 찾기</h2>
        <button onclick="findProblematicFields()">문제 필드 분석</button>
        <pre id="problematic-output"></pre>
    </div>

    <script>
        // isTask 함수를 그대로 재현 (디버깅 로그 포함)
        function isTask(data) {
            const debugLog = [];

            if (typeof data !== 'object' || data === null) {
                debugLog.push('❌ Data is not an object or is null');
                console.log('[isTask] Debug:', debugLog);
                return { valid: false, debugLog };
            }

            const t = data;

            // Required fields
            if (!t.id || typeof t.id !== 'string') {
                debugLog.push(`❌ Invalid id: "${t.id}" (type: ${typeof t.id})`);
                console.log('[isTask] Debug:', debugLog);
                return { valid: false, debugLog };
            }
            debugLog.push(`✅ id: "${t.id}"`);

            if (!t.userId || typeof t.userId !== 'string') {
                debugLog.push(`❌ Invalid userId: "${t.userId}" (type: ${typeof t.userId})`);
                console.log('[isTask] Debug:', debugLog);
                return { valid: false, debugLog };
            }
            debugLog.push(`✅ userId: "${t.userId}"`);

            if (!t.title || typeof t.title !== 'string') {
                debugLog.push(`❌ Invalid title: "${t.title}" (type: ${typeof t.title})`);
                console.log('[isTask] Debug:', debugLog);
                return { valid: false, debugLog };
            }
            debugLog.push(`✅ title: "${t.title}"`);

            if (!['pending', 'in_progress', 'completed', 'cancelled'].includes(t.status)) {
                debugLog.push(`❌ Invalid status: "${t.status}"`);
                console.log('[isTask] Debug:', debugLog);
                return { valid: false, debugLog };
            }
            debugLog.push(`✅ status: "${t.status}"`);

            if (!['low', 'medium', 'high', 'urgent'].includes(t.priority)) {
                debugLog.push(`❌ Invalid priority: "${t.priority}"`);
                console.log('[isTask] Debug:', debugLog);
                return { valid: false, debugLog };
            }
            debugLog.push(`✅ priority: "${t.priority}"`);

            // Check createdAt and updatedAt
            if (!t.createdAt || typeof t.createdAt !== 'string') {
                debugLog.push(`❌ Invalid createdAt: "${t.createdAt}" (type: ${typeof t.createdAt})`);
                console.log('[isTask] Debug:', debugLog);
                return { valid: false, debugLog };
            }
            debugLog.push(`✅ createdAt: "${t.createdAt}"`);

            if (!t.updatedAt || typeof t.updatedAt !== 'string') {
                debugLog.push(`❌ Invalid updatedAt: "${t.updatedAt}" (type: ${typeof t.updatedAt})`);
                console.log('[isTask] Debug:', debugLog);
                return { valid: false, debugLog };
            }
            debugLog.push(`✅ updatedAt: "${t.updatedAt}"`);

            // Optional fields - null과 undefined는 허용
            const optionalFields = [
                'projectId', 'description', 'assigneeId', 'parentTaskId',
                'dueDate', 'startDate', 'completedAt', 'estimatedHours',
                'actualHours', 'updated_by', 'device_id', 'sectionId'
            ];

            for (const field of optionalFields) {
                if (t[field] !== undefined && t[field] !== null) {
                    if (field.endsWith('Hours')) {
                        // Number fields
                        if (typeof t[field] !== 'number' || t[field] < 0) {
                            debugLog.push(`❌ Invalid ${field}: "${t[field]}" (type: ${typeof t[field]}, must be non-negative number)`);
                            console.log('[isTask] Debug:', debugLog);
                            return { valid: false, debugLog };
                        }
                        debugLog.push(`✅ ${field}: ${t[field]}`);
                    } else {
                        // String fields
                        if (typeof t[field] !== 'string') {
                            debugLog.push(`❌ Invalid ${field}: "${t[field]}" (type: ${typeof t[field]}, expected string)`);
                            console.log('[isTask] Debug:', debugLog);
                            return { valid: false, debugLog };
                        }
                        debugLog.push(`✅ ${field}: "${t[field]}"`);
                    }
                } else {
                    debugLog.push(`ℹ️ ${field}: ${t[field] === null ? 'null' : 'undefined'} (allowed)`);
                }
            }

            // Array fields
            const arrayFields = ['subtasks', 'dependencies', 'tags'];
            for (const field of arrayFields) {
                if (t[field] !== undefined && t[field] !== null) {
                    if (!Array.isArray(t[field])) {
                        debugLog.push(`❌ Invalid ${field}: not an array`);
                        console.log('[isTask] Debug:', debugLog);
                        return { valid: false, debugLog };
                    }
                    if (!t[field].every(item => typeof item === 'string')) {
                        debugLog.push(`❌ Invalid ${field}: not all items are strings`);
                        console.log('[isTask] Debug:', debugLog);
                        return { valid: false, debugLog };
                    }
                    debugLog.push(`✅ ${field}: [${t[field].length} items]`);
                } else {
                    debugLog.push(`ℹ️ ${field}: ${t[field] === null ? 'null' : 'undefined'} (allowed)`);
                }
            }

            // Check attachments
            if (t.attachments !== undefined && t.attachments !== null) {
                if (!Array.isArray(t.attachments)) {
                    debugLog.push(`❌ Invalid attachments: not an array`);
                    console.log('[isTask] Debug:', debugLog);
                    return { valid: false, debugLog };
                }
                // Simple check for attachments
                debugLog.push(`✅ attachments: [${t.attachments.length} items]`);
            } else {
                debugLog.push(`ℹ️ attachments: ${t.attachments === null ? 'null' : 'undefined'} (allowed)`);
            }

            // Check recurring
            if (t.recurring !== undefined && t.recurring !== null) {
                if (typeof t.recurring !== 'object') {
                    debugLog.push(`❌ Invalid recurring: not an object`);
                    console.log('[isTask] Debug:', debugLog);
                    return { valid: false, debugLog };
                }
                if (!['daily', 'weekly', 'monthly', 'yearly'].includes(t.recurring.pattern)) {
                    debugLog.push(`❌ Invalid recurring.pattern: "${t.recurring.pattern}"`);
                    console.log('[isTask] Debug:', debugLog);
                    return { valid: false, debugLog };
                }
                debugLog.push(`✅ recurring: pattern="${t.recurring.pattern}"`);
            } else {
                debugLog.push(`ℹ️ recurring: ${t.recurring === null ? 'null' : 'undefined'} (allowed)`);
            }

            debugLog.push('✅ All validations passed');
            console.log('[isTask] Debug:', debugLog);
            return { valid: true, debugLog };
        }

        function checkLocalStorage() {
            const output = document.getElementById('localStorage-output');
            const tasksKey = 'weave_v2_tasks';
            const data = localStorage.getItem(tasksKey);

            if (!data) {
                output.innerHTML = '<span class="error">No tasks found in localStorage</span>';
                return;
            }

            try {
                const tasks = JSON.parse(data);
                output.innerHTML = `Found ${tasks.length} tasks in localStorage:\n\n` +
                    JSON.stringify(tasks, null, 2);
            } catch (e) {
                output.innerHTML = `<span class="error">Error parsing tasks: ${e.message}</span>`;
            }
        }

        function validateTasks() {
            const output = document.getElementById('validation-output');
            const tasksKey = 'weave_v2_tasks';
            const data = localStorage.getItem(tasksKey);

            if (!data) {
                output.innerHTML = '<span class="error">No tasks found in localStorage</span>';
                return;
            }

            try {
                const tasks = JSON.parse(data);
                let results = `Total tasks: ${tasks.length}\n\n`;

                tasks.forEach((task, index) => {
                    results += `=== Task ${index + 1} (ID: ${task.id}) ===\n`;
                    const validation = isTask(task);

                    if (validation.valid) {
                        results += '<span class="success">✅ VALID</span>\n';
                    } else {
                        results += '<span class="error">❌ INVALID</span>\n';
                    }

                    results += 'Validation Log:\n';
                    validation.debugLog.forEach(log => {
                        results += `  ${log}\n`;
                    });
                    results += '\n';
                });

                output.innerHTML = results;
            } catch (e) {
                output.innerHTML = `<span class="error">Error: ${e.message}</span>`;
            }
        }

        function simulateUpdate() {
            const output = document.getElementById('update-output');
            const taskIdInput = document.getElementById('taskId').value;

            if (!taskIdInput) {
                output.innerHTML = '<span class="error">Please enter a task ID</span>';
                return;
            }

            const tasksKey = 'weave_v2_tasks';
            const data = localStorage.getItem(tasksKey);

            if (!data) {
                output.innerHTML = '<span class="error">No tasks found in localStorage</span>';
                return;
            }

            try {
                const tasks = JSON.parse(data);
                const task = tasks.find(t => t.id === taskIdInput);

                if (!task) {
                    output.innerHTML = `<span class="error">Task with ID "${taskIdInput}" not found</span>`;
                    return;
                }

                // Simulate BaseService.update behavior
                const now = new Date().toISOString();
                const deviceId = localStorage.getItem('weave_device_id') || 'device_test_123';

                const updatedTask = {
                    ...task,
                    dueDate: now, // Simulate date update
                    updatedAt: now,
                    device_id: deviceId
                };

                output.innerHTML = 'Original Task:\n' + JSON.stringify(task, null, 2) + '\n\n';
                output.innerHTML += 'Updated Task:\n' + JSON.stringify(updatedTask, null, 2) + '\n\n';

                const validation = isTask(updatedTask);
                output.innerHTML += 'Validation Result:\n';

                if (validation.valid) {
                    output.innerHTML += '<span class="success">✅ VALID</span>\n';
                } else {
                    output.innerHTML += '<span class="error">❌ INVALID</span>\n';
                }

                output.innerHTML += '\nValidation Log:\n';
                validation.debugLog.forEach(log => {
                    output.innerHTML += `${log}\n`;
                });

            } catch (e) {
                output.innerHTML = `<span class="error">Error: ${e.message}</span>`;
            }
        }

        function findProblematicFields() {
            const output = document.getElementById('problematic-output');
            const tasksKey = 'weave_v2_tasks';
            const data = localStorage.getItem(tasksKey);

            if (!data) {
                output.innerHTML = '<span class="error">No tasks found in localStorage</span>';
                return;
            }

            try {
                const tasks = JSON.parse(data);
                const fieldIssues = {};

                tasks.forEach((task) => {
                    // Check each field for potential issues
                    Object.keys(task).forEach(key => {
                        const value = task[key];
                        const valueType = typeof value;
                        const isNull = value === null;

                        if (!fieldIssues[key]) {
                            fieldIssues[key] = {
                                types: new Set(),
                                nullCount: 0,
                                undefinedCount: 0,
                                samples: []
                            };
                        }

                        if (isNull) {
                            fieldIssues[key].nullCount++;
                        } else if (value === undefined) {
                            fieldIssues[key].undefinedCount++;
                        } else {
                            fieldIssues[key].types.add(valueType);
                            if (fieldIssues[key].samples.length < 3) {
                                fieldIssues[key].samples.push(
                                    valueType === 'object' ? JSON.stringify(value) : value
                                );
                            }
                        }
                    });
                });

                let report = 'Field Analysis Report:\n\n';

                Object.keys(fieldIssues).forEach(field => {
                    const issue = fieldIssues[field];
                    report += `Field: ${field}\n`;
                    report += `  Types found: ${Array.from(issue.types).join(', ')}\n`;
                    report += `  Null count: ${issue.nullCount}\n`;
                    report += `  Undefined count: ${issue.undefinedCount}\n`;

                    if (issue.samples.length > 0) {
                        report += `  Samples:\n`;
                        issue.samples.forEach(sample => {
                            report += `    - ${sample}\n`;
                        });
                    }

                    // Flag potential issues
                    if (issue.types.size > 1) {
                        report += `  ⚠️ WARNING: Multiple types found!\n`;
                    }

                    report += '\n';
                });

                output.textContent = report;
            } catch (e) {
                output.innerHTML = `<span class="error">Error: ${e.message}</span>`;
            }
        }

        // Auto-run on load
        window.onload = function() {
            console.log('Task Drag Validation Test Page Loaded');
            console.log('Click the buttons to run different tests');
        };
    </script>
</body>
</html>