'use client';

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import { ViewMode } from '@/components/ui/view-mode-switch';
import ProjectHeader from '../ProjectHeader';
import ListView from './ListView';
import DetailView from './DetailView';
import ProjectCreateModal from '../ProjectCreateModal';
import type { ProjectTableRow } from '@/lib/types/project-table.types';
import { useProjectTable } from '@/lib/hooks/useProjectTable';
import { getButtonText } from '@/config/brand';
import { fetchMockProjects, addCustomProject } from '@/lib/mock/projects';

export default function ProjectsView() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  const urlViewMode = searchParams.get('view') as ViewMode | null;
  const selectedProjectId = searchParams.get('selected');

  const [viewMode, setViewMode] = useState<ViewMode>('list');
  const [isInitialized, setIsInitialized] = useState(false);
  const [rawProjectData, setRawProjectData] = useState<ProjectTableRow[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);

  // ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
  const refreshProjectData = useCallback(async () => {
    console.log('üîÑ ProjectsView: ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë');
    setLoading(true);

    try {
      const data = await fetchMockProjects();
      setRawProjectData(data);
      console.log('‚úÖ ProjectsView: ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å', data.length, 'Í∞ú ÌîÑÎ°úÏ†ùÌä∏');

      // useProjectTableÏùò useEffectÍ∞Ä initialData Î≥ÄÍ≤ΩÏùÑ Í∞êÏßÄÌïòÏó¨ ÏûêÎèô ÎèôÍ∏∞ÌôîÎê®
    } catch (error) {
      console.error('‚ùå ProjectsView: ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®', error);
    } finally {
      setLoading(false);
    }
  }, []);

  // useProjectTable ÌõÖÏúºÎ°úÎ∂ÄÌÑ∞ Î™®Îì† ÌïÑÏöîÌïú Í∞íÎì§ Í∞ÄÏ†∏Ïò§Í∏∞
  const {
    data: sortedProjectData,
    updateData,
    // ÌÖåÏù¥Î∏î ÏÑ§Ï†ï
    config,
    updateConfig,
    resetColumnConfig,
    resetFilters,
    updatePageSize,
    // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò
    paginatedData,
    filteredCount,
    totalCount,
    totalPages,
    updatePage,
    canGoToPreviousPage,
    canGoToNextPage,
    goToFirstPage,
    goToPreviousPage,
    goToNextPage,
    goToLastPage,
    // ÏÇ≠Ï†ú Î™®Îìú
    isDeleteMode,
    selectedItems,
    toggleDeleteMode,
    handleItemSelect,
    handleSelectAll,
    handleDeselectAll,
    handleDeleteSelected,
    // Í∏∞ÌÉÄ
    availableClients
  } = useProjectTable(rawProjectData, refreshProjectData);

  useEffect(() => {
    if (!isInitialized) {
      if (urlViewMode === 'list' || urlViewMode === 'detail') {
        setViewMode(urlViewMode);
      } else {
        const savedMode = localStorage.getItem('preferredViewMode') as ViewMode | null;
        if (savedMode === 'list' || savedMode === 'detail') {
          setViewMode(savedMode);
        }
      }
      setIsInitialized(true);
    }
  }, [urlViewMode, isInitialized]);

  useEffect(() => {
    const currentUrlViewMode = searchParams.get('view') as ViewMode | null;
    if (
      isInitialized &&
      viewMode === 'detail' &&
      currentUrlViewMode === 'detail' &&
      !selectedProjectId &&
      sortedProjectData.length > 0 &&
      !loading
    ) {
      const params = new URLSearchParams(searchParams.toString());
      params.set('selected', sortedProjectData[0].no);
      router.push(`${pathname}?${params.toString()}`, { scroll: false });
    }
  }, [isInitialized, viewMode, selectedProjectId, sortedProjectData, loading, pathname, router, searchParams]);

  const handleViewModeChange = useCallback((newMode: ViewMode) => {
    setViewMode(newMode);
    localStorage.setItem('preferredViewMode', newMode);

    const params = new URLSearchParams(searchParams.toString());
    params.set('view', newMode);

    if (newMode === 'list') {
      params.delete('selected');
    } else if (newMode === 'detail' && !params.has('selected') && sortedProjectData.length > 0) {
      params.set('selected', sortedProjectData[0].no);
    }

    router.push(`${pathname}?${params.toString()}`, { scroll: false });
  }, [pathname, router, searchParams, sortedProjectData]);

  const handleProjectSelect = useCallback((projectNo: string) => {
    router.push(`/projects/${projectNo}`);
  }, [router]);

  const handleCreateProject = useCallback(() => {
    console.log('üìù ProjectsView: ÏÉà ÌîÑÎ°úÏ†ùÌä∏ Î≤ÑÌäº ÌÅ¥Î¶≠Îê®!');
    setIsCreateModalOpen(true);
  }, []);

  // WEAVE_num ÌîÑÎ°úÏ†ùÌä∏ Î≤àÌò∏ÏóêÏÑú Îã§Ïùå ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Î≤àÌò∏Î•º Ï∞æÎäî Ìó¨Ìçº Ìï®Ïàò
  const getNextProjectNumber = useCallback((existingProjects: ProjectTableRow[]): string => {
    // Í∏∞Ï°¥ ÌîÑÎ°úÏ†ùÌä∏Îì§Ïùò WEAVE_xxx Î≤àÌò∏ÏóêÏÑú xxx Î∂ÄÎ∂ÑÏùÑ Ï∂îÏ∂úÌïòÏó¨ Ïà´ÏûêÎ°ú Î≥ÄÌôò
    const existingNumbers = existingProjects
      .map(p => p.no)
      .filter(no => no.startsWith('WEAVE_'))
      .map(no => {
        const match = no.match(/^WEAVE_(\d+)$/);
        return match ? parseInt(match[1], 10) : 0;
      })
      .filter(num => !isNaN(num));

    console.log('üìä Í∏∞Ï°¥ WEAVE Î≤àÌò∏Îì§:', existingNumbers);

    // ÏµúÎåÄÍ∞í Ï∞æÍ∏∞ (ÏóÜÏúºÎ©¥ 0)
    const maxNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) : 0;
    const nextNumber = maxNumber + 1;

    console.log('üî¢ Îã§Ïùå ÌîÑÎ°úÏ†ùÌä∏ Î≤àÌò∏:', `WEAVE_${String(nextNumber).padStart(3, '0')}`);
    return `WEAVE_${String(nextNumber).padStart(3, '0')}`;
  }, []);

  const handleProjectCreate = useCallback(async (newProject: Omit<ProjectTableRow, 'id' | 'no' | 'modifiedDate'>) => {
    console.log('üöÄ ProjectsView: handleProjectCreate Ìò∏Ï∂úÎê®!', newProject);
    try {
      // ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ID Î∞è Î≤àÌò∏ ÏÉùÏÑ±
      const timestamp = Date.now();
      const projectId = `project-${timestamp}`;
      const projectNo = getNextProjectNumber(rawProjectData);

      const projectWithId: ProjectTableRow = {
        ...newProject,
        id: projectId,
        no: projectNo,
        modifiedDate: new Date().toISOString().split('T')[0],
        // ÎàÑÎùΩÎêú ÌïÑÎìú Ï∂îÍ∞Ä
        documents: [],
        documentStatus: {
          contract: { exists: false, status: 'none', count: 0 },
          invoice: { exists: false, status: 'none', count: 0 },
          report: { exists: false, status: 'none', count: 0 },
          estimate: { exists: false, status: 'none', count: 0 },
          etc: { exists: false, status: 'none', count: 0 }
        }
      };

      console.log('üíæ ÏÉùÏÑ±Îêú ÌîÑÎ°úÏ†ùÌä∏:', projectWithId);

      // localStorageÏóê ÏÉà ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû•
      addCustomProject(projectWithId);

      // ÌòÑÏû¨ ÏÉÅÌÉúÏóê ÏßÅÏ†ë ÏÉà ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä (Îß® ÏïûÏóê Î∞∞Ïπò)
      const updatedData = [projectWithId, ...rawProjectData];
      console.log('üìä ÏóÖÎç∞Ïù¥Ìä∏Îêú Îç∞Ïù¥ÌÑ∞ Í∏∏Ïù¥:', updatedData.length);

      setRawProjectData(updatedData);
      updateData(updatedData);

      // Î™®Îã¨ Îã´Í∏∞
      setIsCreateModalOpen(false);

      // ÏÑ±Í≥µ Î©îÏãúÏßÄ
      console.log('‚úÖ ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏôÑÎ£å:', projectWithId.name);

      // Detail Î∑∞ÏóêÏÑú ÏÉà ÌîÑÎ°úÏ†ùÌä∏Î°ú Ïù¥Îèô
      if (viewMode === 'detail') {
        const params = new URLSearchParams(searchParams.toString());
        params.set('selected', projectNo);
        router.push(`${pathname}?${params.toString()}`, { scroll: false });
      }
    } catch (error) {
      console.error('‚ùå ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Ïã§Ìå®:', error);
    }
  }, [rawProjectData, viewMode, searchParams, pathname, router, updateData, getNextProjectNumber]);

  const stats = useMemo(() => {
    if (loading || rawProjectData.length === 0) {
      return {
        totalCount: 0,
        inProgress: 0,
        completed: 0,
        review: 0
      };
    }

    return {
      totalCount: rawProjectData.length,
      inProgress: rawProjectData.filter(p => p.status === 'in_progress').length,
      completed: rawProjectData.filter(p => p.status === 'completed').length,
      review: rawProjectData.filter(p => p.status === 'review').length
    };
  }, [rawProjectData, loading]);

  useEffect(() => {
    const loadData = async () => {
      setLoading(true);

      // Ï§ëÏïôÌôîÎêú mock Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
      const data = await fetchMockProjects();
      setRawProjectData(data);
      setLoading(false);
    };

    loadData();
  }, []);

  // ÌéòÏù¥ÏßÄ Ìè¨Ïª§Ïä§ Ïãú Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® (localStorage Î≥ÄÍ≤Ω Í∞êÏßÄ)
  useEffect(() => {
    const handleVisibilityChange = () => {
      if (!document.hidden) {
        console.log('üì± ÌéòÏù¥ÏßÄ Ìè¨Ïª§Ïä§ Í∞êÏßÄ - ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®');
        refreshProjectData();
      }
    };

    const handleFocus = () => {
      console.log('üîÑ ÏúàÎèÑÏö∞ Ìè¨Ïª§Ïä§ Í∞êÏßÄ - ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®');
      refreshProjectData();
    };

    // ÌéòÏù¥ÏßÄ visibility Î≥ÄÍ≤Ω Í∞êÏßÄ (ÌÉ≠ Ï†ÑÌôò Îì±)
    document.addEventListener('visibilitychange', handleVisibilityChange);
    // ÏúàÎèÑÏö∞ Ìè¨Ïª§Ïä§ Í∞êÏßÄ (Îã§Î•∏ Ïï±ÏóêÏÑú ÎèåÏïÑÏò¨ Îïå)
    window.addEventListener('focus', handleFocus);

    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('focus', handleFocus);
    };
  }, [refreshProjectData]);

  // Clean Slate: Î≥µÏû°Ìïú Î≥ëÌï© Î°úÏßÅ Ï†úÍ±∞Îê®

  if (!isInitialized) {
    return (
      <div className="container mx-auto p-6">
        <div className="flex items-center justify-center h-64">
          <div className="text-muted-foreground">{getButtonText.loading('ko')}</div>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-6">
      <ProjectHeader
        viewMode={viewMode}
        onViewModeChange={handleViewModeChange}
        onCreateProject={handleCreateProject}
        stats={stats}
        loading={loading}
      />

      {viewMode === 'list' ? (
        <ListView
          projects={sortedProjectData}
          onProjectClick={handleProjectSelect}
          loading={loading}
          showColumnSettings={true}
          onProjectsChange={refreshProjectData}
          viewMode={viewMode}
          onViewModeChange={handleViewModeChange}
          // useProjectTable ÏÉÅÌÉúÎ•º ListViewÏóê Ï†ÑÎã¨
          config={config}
          updateConfig={updateConfig}
          resetColumnConfig={resetColumnConfig}
          resetFilters={resetFilters}
          updatePageSize={updatePageSize}
          paginatedData={paginatedData}
          filteredCount={filteredCount}
          totalCount={totalCount}
          totalPages={totalPages}
          updatePage={updatePage}
          canGoToPreviousPage={canGoToPreviousPage}
          canGoToNextPage={canGoToNextPage}
          goToFirstPage={goToFirstPage}
          goToPreviousPage={goToPreviousPage}
          goToNextPage={goToNextPage}
          goToLastPage={goToLastPage}
          isDeleteMode={isDeleteMode}
          selectedItems={selectedItems}
          toggleDeleteMode={toggleDeleteMode}
          handleItemSelect={handleItemSelect}
          handleSelectAll={handleSelectAll}
          handleDeselectAll={handleDeselectAll}
          handleDeleteSelected={handleDeleteSelected}
          availableClients={availableClients}
        />
      ) : (
        <DetailView
          projects={sortedProjectData}
          selectedProjectId={selectedProjectId}
          loading={loading}
          showColumnSettings={false}
          onProjectsChange={refreshProjectData}
          viewMode={viewMode}
          onViewModeChange={handleViewModeChange}
        />
      )}

      {/* ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Î™®Îã¨ */}
      <ProjectCreateModal
        isOpen={isCreateModalOpen}
        onClose={() => setIsCreateModalOpen(false)}
        onProjectCreate={handleProjectCreate}
      />
    </div>
  );
}
