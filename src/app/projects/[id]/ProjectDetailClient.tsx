'use client';

import { useState, useEffect, useMemo, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import ProjectDetail from '@/components/projects/ProjectDetail';
import { DeleteDialog } from '@/components/ui/dialogDelete';
import ProjectCreateModal from '@/app/projects/components/ProjectCreateModal';
import { AlertCircleIcon } from 'lucide-react';
import { getProjectPageText } from '@/config/brand';
import type { ProjectTableRow } from '@/lib/types/project-table.types';
import { fetchMockProjects, fetchMockProject, removeCustomProject, addCustomProject, updateCustomProject } from '@/lib/mock/projects';
import { useToast } from '@/hooks/use-toast';

interface ProjectDetailClientProps {
  projectId: string;
}

/**
 * Client Component Wrapper for ProjectDetail
 * Handles client-side interactions and navigation with localStorage support
 */
export default function ProjectDetailClient({ projectId }: ProjectDetailClientProps) {
  const router = useRouter();
  const { toast } = useToast();
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
  const [projectList, setProjectList] = useState<ProjectTableRow[]>([]);
  const [project, setProject] = useState<ProjectTableRow | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const lang = 'ko';

  const handleClose = () => {
    // Navigate back to projects list
    router.push('/projects');
  };

  const handleCreateProject = () => {
    console.log('üìù ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Î™®Îã¨ Ïó¥Í∏∞');
    setIsCreateModalOpen(true);
  };

  const handleProjectCreate = useCallback((newProject: Omit<ProjectTableRow, 'id' | 'no' | 'modifiedDate'>) => {
    try {
      // ÏÉà ÌîÑÎ°úÏ†ùÌä∏ IDÏôÄ Î≤àÌò∏ ÏÉùÏÑ±
      const timestamp = Date.now();
      const projectWithId: ProjectTableRow = {
        ...newProject,
        id: `project-${timestamp}`,
        no: `WEAVE_${String(projectList.length + 1).padStart(3, '0')}`,
        modifiedDate: new Date().toISOString()
      };

      // localStorageÏóê ÌîÑÎ°úÏ†ùÌä∏ Ï∂îÍ∞Ä
      addCustomProject(projectWithId);

      console.log('‚úÖ ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏÑ±Í≥µ:', {
        id: projectWithId.id,
        no: projectWithId.no,
        name: projectWithId.name
      });

      // ÏÑ±Í≥µ ÌÜ†Ïä§Ìä∏ ÌëúÏãú
      toast({
        title: "ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏôÑÎ£å",
        description: `${projectWithId.name} ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.`,
      });

      // Î™®Îã¨ Îã´Í∏∞ Î∞è ÏÉà ÌîÑÎ°úÏ†ùÌä∏Î°ú Ïù¥Îèô
      setIsCreateModalOpen(false);
      router.push(`/projects/${projectWithId.no}`);
    } catch (error) {
      console.error('‚ùå ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);

      // Ïò§Î•ò ÌÜ†Ïä§Ìä∏ ÌëúÏãú
      toast({
        title: "ÏÉùÏÑ± Ïò§Î•ò",
        description: "ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
        variant: "destructive",
      });
    }
  }, [projectList.length, toast, router]);

  useEffect(() => {
    let mounted = true;

    const loadData = async () => {
      try {
        setLoading(true);
        setError(null);

        // ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ÏôÄ ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ùÏùÑ Î≥ëÎ†¨Î°ú Î°úÎî©
        const [projectData, projectsData] = await Promise.all([
          fetchMockProject(projectId),
          fetchMockProjects()
        ]);

        if (mounted) {
          if (projectData) {
            setProject(projectData);
            setProjectList(projectsData);
            console.log('‚úÖ Í∞úÎ≥Ñ ÌîÑÎ°úÏ†ùÌä∏ ÌéòÏù¥ÏßÄ: Îç∞Ïù¥ÌÑ∞ Î°úÎî© ÏÑ±Í≥µ', {
              id: projectData.id,
              no: projectData.no,
              name: projectData.name,
              client: projectData.client
            });
          } else {
            setError('ÌîÑÎ°úÏ†ùÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§');
            console.log('‚ùå Í∞úÎ≥Ñ ÌîÑÎ°úÏ†ùÌä∏ ÌéòÏù¥ÏßÄ: ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå', projectId);
          }
        }
      } catch (error) {
        console.error('Failed to load project data', error);
        if (mounted) {
          setError('ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§');
        }
      } finally {
        if (mounted) {
          setLoading(false);
        }
      }
    };

    loadData();

    return () => {
      mounted = false;
    };
  }, [projectId]);

  // ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
  const refreshProjectData = useCallback(async () => {
    if (!projectId) return;

    try {
      const updatedProject = await fetchMockProject(projectId);
      if (updatedProject) {
        setProject(updatedProject);
        console.log('‚úÖ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å:', {
          id: updatedProject.id,
          no: updatedProject.no,
          name: updatedProject.name
        });
      }
    } catch (error) {
      console.error('‚ùå ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:', error);
    }
  }, [projectId]);

  const combinedProjects = useMemo(() => {
    if (!project) return projectList;

    const map = new Map<string, ProjectTableRow>();
    projectList.forEach((item) => {
      map.set(item.no, item);
    });
    map.set(project.no, project);
    return Array.from(map.values());
  }, [project, projectList]);

  const sortedProjects = useMemo(() => {
    return [...combinedProjects].sort((a, b) => a.no.localeCompare(b.no));
  }, [combinedProjects]);

  const currentIndex = useMemo(() => {
    if (!project) return -1;
    return sortedProjects.findIndex((item) => item.no === project.no);
  }, [sortedProjects, project]);

  const canNavigatePrevious = currentIndex > 0;
  const canNavigateNext = currentIndex !== -1 && currentIndex < sortedProjects.length - 1;

  const handleNavigatePrevious = useCallback(() => {
    if (!canNavigatePrevious) {
      return;
    }

    const previousProject = sortedProjects[currentIndex - 1];
    if (previousProject) {
      router.push(`/projects/${previousProject.no}`);
    }
  }, [canNavigatePrevious, currentIndex, sortedProjects, router]);

  const handleNavigateNext = useCallback(() => {
    if (!canNavigateNext) {
      return;
    }

    const nextProject = sortedProjects[currentIndex + 1];
    if (nextProject) {
      router.push(`/projects/${nextProject.no}`);
    }
  }, [canNavigateNext, currentIndex, sortedProjects, router]);

  const handleEdit = () => {
    if (!project) return;

    // Í∞ÑÎã®Ìïú ÌîÑÎ°úÏ†ùÌä∏Î™Ö Ìé∏Ïßë (Ìñ•ÌõÑ ÏôÑÏ†ÑÌïú Ìé∏Ïßë Î™®Îã¨Î°ú ÏóÖÍ∑∏Î†àÏù¥Îìú ÏòàÏ†ï)
    const newName = prompt('ÌîÑÎ°úÏ†ùÌä∏Î™ÖÏùÑ ÏàòÏ†ïÌïòÏÑ∏Ïöî:', project.name);

    if (newName && newName.trim() && newName.trim() !== project.name) {
      try {
        const success = updateCustomProject(project.no, {
          name: newName.trim()
        });

        if (success) {
          console.log('‚úÖ ÌîÑÎ°úÏ†ùÌä∏ Ìé∏Ïßë ÏÑ±Í≥µ:', {
            id: project.id,
            no: project.no,
            oldName: project.name,
            newName: newName.trim()
          });

          // ÏÑ±Í≥µ ÌÜ†Ïä§Ìä∏ ÌëúÏãú
          toast({
            title: "ÌîÑÎ°úÏ†ùÌä∏ ÏàòÏ†ï ÏôÑÎ£å",
            description: `ÌîÑÎ°úÏ†ùÌä∏Î™ÖÏù¥ "${newName.trim()}"Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`,
          });

          // ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
          refreshProjectData();
        } else {
          console.log('‚ö†Ô∏è ÌîÑÎ°úÏ†ùÌä∏ Ìé∏Ïßë Ïã§Ìå®: ÌîÑÎ°úÏ†ùÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå', project.no);

          // Ïã§Ìå® ÌÜ†Ïä§Ìä∏ ÌëúÏãú
          toast({
            title: "ÏàòÏ†ï Ïã§Ìå®",
            description: "ÌîÑÎ°úÏ†ùÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÍ±∞ÎÇò ÏàòÏ†ïÌï† Ïàò ÏóÜÏäµÎãàÎã§.",
            variant: "destructive",
          });
        }
      } catch (error) {
        console.error('‚ùå ÌîÑÎ°úÏ†ùÌä∏ Ìé∏Ïßë Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);

        // Ïò§Î•ò ÌÜ†Ïä§Ìä∏ ÌëúÏãú
        toast({
          title: "ÏàòÏ†ï Ïò§Î•ò",
          description: "ÌîÑÎ°úÏ†ùÌä∏ ÏàòÏ†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
          variant: "destructive",
        });
      }
    } else if (newName === '') {
      // Îπà Î¨∏ÏûêÏó¥ ÏûÖÎ†• Ïãú Í≤ΩÍ≥†
      toast({
        title: "ÏûÖÎ†• Ïò§Î•ò",
        description: "ÌîÑÎ°úÏ†ùÌä∏Î™ÖÏùÄ ÎπÑÏñ¥ÏûàÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.",
        variant: "destructive",
      });
    }
    // Ï∑®ÏÜåÌïòÍ±∞ÎÇò ÎèôÏùºÌïú Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìïú Í≤ΩÏö∞ ÏïÑÎ¨¥Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå
  };

  const handleDelete = () => {
    if (!project) return;
    setIsDeleteModalOpen(true);
  };

  const handleConfirmDelete = () => {
    if (!project) return;

    try {
      // localStorageÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú
      const deleted = removeCustomProject(project.no);

      if (deleted) {
        console.log('‚úÖ ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú ÏÑ±Í≥µ:', { id: project.id, no: project.no, name: project.name });

        // ÏÑ±Í≥µ ÌÜ†Ïä§Ìä∏ ÌëúÏãú
        toast({
          title: "ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú ÏôÑÎ£å",
          description: `${project.name} ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`,
        });

        // Î™®Îã¨ Îã´Í∏∞ Î∞è ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ùÏúºÎ°ú Ïù¥Îèô
        setIsDeleteModalOpen(false);
        router.push('/projects');
      } else {
        console.log('‚ö†Ô∏è ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú Ïã§Ìå®: ÌîÑÎ°úÏ†ùÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå', project.no);

        // Ïã§Ìå® ÌÜ†Ïä§Ìä∏ ÌëúÏãú
        toast({
          title: "ÏÇ≠Ï†ú Ïã§Ìå®",
          description: "ÌîÑÎ°úÏ†ùÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÍ±∞ÎÇò ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.",
          variant: "destructive",
        });

        setIsDeleteModalOpen(false);
      }
    } catch (error) {
      console.error('‚ùå ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);

      // Ïò§Î•ò ÌÜ†Ïä§Ìä∏ ÌëúÏãú
      toast({
        title: "ÏÇ≠Ï†ú Ïò§Î•ò",
        description: "ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
        variant: "destructive",
      });

      setIsDeleteModalOpen(false);
    }
  };

  const handleCancelDelete = () => {
    setIsDeleteModalOpen(false);
  };

  // Î°úÎî© ÏÉÅÌÉú
  if (loading) {
    return (
      <div className="container mx-auto p-6">
        <div className="animate-pulse">
          <div className="mb-6">
            <div className="h-8 bg-muted rounded w-1/3 mb-2"></div>
            <div className="h-4 bg-muted rounded w-1/2"></div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div className="h-32 bg-muted rounded"></div>
            <div className="h-32 bg-muted rounded"></div>
          </div>
          <div className="h-10 bg-muted rounded mb-4"></div>
          <div className="h-64 bg-muted rounded"></div>
        </div>
      </div>
    );
  }

  // ÏóêÎü¨ ÏÉÅÌÉú
  if (error) {
    return (
      <div className="container mx-auto p-6">
        <div className="text-center py-12">
          <AlertCircleIcon className="h-12 w-12 text-destructive mx-auto mb-4" />
          <h2 className="text-2xl font-bold mb-2">ÌîÑÎ°úÏ†ùÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</h2>
          <p className="text-muted-foreground mb-6">{error}</p>
          <button
            onClick={() => router.push('/projects')}
            className="inline-flex h-10 items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow transition-colors hover:bg-primary/90"
          >
            ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
          </button>
        </div>
      </div>
    );
  }

  // ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞
  if (!project) {
    return (
      <div className="container mx-auto p-6">
        <div className="text-center py-12">
          <AlertCircleIcon className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
          <h2 className="text-2xl font-bold mb-2">ÌîÑÎ°úÏ†ùÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§</h2>
          <p className="text-muted-foreground mb-6">ÏöîÏ≤≠ÌïòÏã† ÌîÑÎ°úÏ†ùÌä∏Í∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.</p>
          <button
            onClick={() => router.push('/projects')}
            className="inline-flex h-10 items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground shadow transition-colors hover:bg-primary/90"
          >
            ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
          </button>
        </div>
      </div>
    );
  }

  return (
    <>
      <ProjectDetail
        project={project}
        mode="full"
        onClose={handleClose}
        onEdit={handleEdit}
        onDelete={handleDelete}
        onCreateProject={handleCreateProject}
        onNavigatePrevious={handleNavigatePrevious}
        onNavigateNext={handleNavigateNext}
        canNavigatePrevious={canNavigatePrevious}
        canNavigateNext={canNavigateNext}
      />

      <DeleteDialog
        open={isDeleteModalOpen}
        title={getProjectPageText.deleteModalTitle(lang)}
        description={getProjectPageText.deleteModalMessage(lang)}
        confirmLabel={getProjectPageText.deleteModalConfirm(lang)}
        cancelLabel={getProjectPageText.deleteModalCancel(lang)}
        icon={<AlertCircleIcon className="h-8 w-8 text-destructive" />}
        borderClassName="border-2 border-primary"
        onOpenChange={setIsDeleteModalOpen}
        onConfirm={handleConfirmDelete}
      />

      <ProjectCreateModal
        isOpen={isCreateModalOpen}
        onClose={() => setIsCreateModalOpen(false)}
        onProjectCreate={handleProjectCreate}
      />
    </>
  );
}
